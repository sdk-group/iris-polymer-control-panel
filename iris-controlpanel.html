<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iris-polymer-importer/iris-importer.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../bower_components/iris-polymer-usercard/iris-usercard.html">
<link rel="import" href="../../bower_components/iris-polymer-queuecard/iris-queuecard.html">
<link rel="import" href="../../bower_components/iris-polymer-doomclock/iris-doomclock.html">
<link rel="import" href="../../bower_components/iris-polymer-ticketview/iris-ticketview.html">
<link rel="import" href="../../bower_components/iris-polymer-api/iris-api.html">
<link rel="import" href="../../bower_components/iris-polymer-clock/iris-clock.html">
<link rel="import" href="../../bower_components/iris-polymer-styles/mydoc-color.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<dom-module id="iris-controlpanel">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
        color: var(--mydoc-brown-1000);
        --paper-card-header-color: var(--mydoc-brown-1000);
        --doomclcok-red: {
          color: var(--mydoc-red-800);
        }
      }
      
      #main-info > div {
        height: 250px;
      }
      
      paper-button iron-icon {
        margin-top: -2px;
      }
      
      .cards>::content iris-queuecard {
        margin: 10px;
        @apply(--layout-flex);
        min-width: 200px;
      }
      
      .cards>::content paper-card .items-counter {
        font-size: 24px;
        padding: 10px;
      }
      
      .doomclcok .card-content {
        font-size: 24px;
        text-align: center;
      }
      
      paper-card.doomclcok {
        @apply(--layout-flex-2);
        min-width: 250px;
        margin: 10px;
      }
      
      .ticket-action {
        padding: 0 10px 10px 10px;
      }
      
      .ticket-action paper-button {
        margin-top: 10px;
        font-size: 20px;
      }
      
      paper-spinner {
        height: 20px;
        width: 20px;
        top: 2px;
      }
      
      .break {
        float: left;
      }
      
      .card-content iris-clock {
        float: right;
      }
      
      .red {
        color: var(--mydoc-red-800);
      }
      
      .cards {
        @apply(--layout);
        @apply(--layout-wrap);
      }
    </style>
    <iris-shared-entities id="shared" namespace="services"></iris-shared-entities>
    <iris-settings-access id="settings"></iris-settings-access>

    <iris-currentuser id="user" is-paused="{{isPaused}}"></iris-currentuser>
    <iris-workstation id="workstation" queue-head="{{queue_head}}" postponed-head="{{postponed_head}}" current-ticket="{{currentTicket}}" postponed-count="{{p_count}}" reserved-count="{{r_count}}"></iris-workstation>

    <div class="ticket-actions-interceptor" on-ticket-action="ticketAction">
      <div class="cards">
        <content select="iris-queuecard"></content>
        <iris-queuecard id="live_queue" heading="В очереди" tickets="{{queue_head}}" active="[[canOpenQueue(currentTicket)]]">
          <span class="items-counter">[[r_count]]</span>
          <span class="button-name">список талонов</span>
        </iris-queuecard>
        <iris-queuecard id="postponed_queue" heading="Отложено" tickets="{{postponed_head}}" active="[[canOpenQueue(currentTicket)]]">
          <span class="items-counter">[[p_count]]</span>
          <span class="button-name">список отложенных</span>
        </iris-queuecard>
        <paper-card class="doomclcok" heading="{{doomclockHeading}}" hidden$="[[showClock(isPaused,currentTicket)]]">
          <div class="card-content">
            <iris-doomclock id="countdown"></iris-doomclock>
          </div>
        </paper-card>
        <paper-card class="doomclcok" hidden$="[[!showClock(isPaused,currentTicket)]]">
          <div class="card-content">
            <div class="break red" hidden$="[[!isPaused]]">Перерыв</div>
            <iris-clock timezone="Asia/Dhaka" current-time="{{now}}"></iris-clock>
          </div>
        </paper-card>
      </div>
      <iris-ticketview ticket="{{currentTicket}}" view="stateful">
        <div class="ticket-action flexchild layout vertical">
          <paper-button ticket-action="next" class="btn-primary" raised elevation="0"> Следующий
            <paper-spinner alt="Loading"></paper-spinner>
          </paper-button>
          <paper-button ticket-action="arrived" class="btn-primary" raised elevation="0"> Подошел
            <paper-spinner alt="Loading"></paper-spinner>
          </paper-button>
          <paper-button ticket-action="call-again" class="btn-primary" raised elevation="0"> Повтор вызова
            <paper-spinner alt="Loading"></paper-spinner>
          </paper-button>
          <paper-button ticket-action="postpone" class="btn-primary" raised elevation="0"> Отложить
            <paper-spinner alt="Loading"></paper-spinner>
          </paper-button>
          <paper-button ticket-action="route" class="btn-primary" raised elevation="0"> Передать
            <paper-spinner alt="Loading"></paper-spinner>
          </paper-button>
        </div>
      </iris-ticketview>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'iris-controlpanel',
        properties: {
          currentTicket: {
            value: {},
            observer: '_currentTicketChanged'
          }
        },
        canOpenQueue(currentTicket) {
          return currentTicket.state !== 'called';
        },
        showClock(paused, currentTicket) {
          return paused || !currentTicket.state;
        },
        _currentTicketChanged() {
          console.log('ticket changed');
          let state = !_.isEmpty(this.currentTicket) ? this.currentTicket.state : 'no-state';
          switch (state) {
            case 'registered':
              this.set('doomclockHeading', 'Время ожидания');
              this.$.countdown.direction = 'up';
              this.$.countdown.start = this.currentTicket.booking_date;
              this.$.countdown.redZone = 0;
              break;
            case 'called':
              this.set('doomclockHeading', 'Ожидание посетителя');
              this.$.countdown.direction = 'down';
              this.$.countdown.redZone = this.waiting_red_zone;
              this.$.countdown.start = this.waiting_time;

              this.lockArriveButton();

              break;
            case 'processing':
              this.set('doomclockHeading', 'Время обслуживания');
              this.$.countdown.direction = 'down';
              this.$.countdown.start = Date.now();
              console.log(this.currentTicket);
              let time_of_service = (this.currentTicket.time_description[1] - this.currentTicket.time_description[0]) * 1000;
              console.log('Time of service', time_of_service);
              this.$.countdown.redZone = _.floor(0.3 * time_of_service);
              this.$.countdown.start = time_of_service;
              break;
            case 'no-state':
              this.$.countdown.direction = 'up';
              this.$.countdown.start = Date.now();
              this.$.countdown.redZone = 0;
              this.set('doomclockHidden', true);
              break;
          }
          this.$.countdown.restart();
        },
        ready() {

          let standart = [{
            label: "Действие",
            caption: "Принять",
            name: 'process',
            transform: 'action'
          }, {
            label: "№ талона",
            field: 'label'
          }, {
            label: 'Услуга',
            field: 'service',
            transform: (ticket) => {
              let service_id = ticket.service;
              return this.$.shared.get(service_id).label;
            }
          }, {
            label: 'Число дел',
            field: 'service_count'
          }, {
            label: 'ФИО',
            field: 'fio',
            transform: function(ticket) {
              return ticket.client.fio;
            }
          }];
          this.$.live_queue.row_model = _.concat(standart, [{
            label: 'Время ожидания',
            field: ['booking_date'],
            transform: 'doomclock'
          }]);

          this.$.postponed_queue.row_model = standart;
          this.now = Date.now();
          this.doomclockHeading = 'Время ожидания';
          this.doomclockHidden = true;
          this.request_in_progress = false;
          this.waiting_time = 45000;
          this.waiting_red_zone = 15000;

          let self = this;

          this.action_handlers = {
            'next': function(ticket) {
              return self.$.workstation.getNext();
            },
            'call-again': function(ticket) {
              return ticket.callAgain();
            },
            'route': function(ticket) {
              console.log('Open route dialog here');
              return Promise.resolve(true)
            },
            'process': function(ticket) {
              return self.$.workstation.getTicketById(ticket);
            },
            'postpone': function(ticket) {
              return self.$.workstation.postponeTicket(ticket);
            },
            'default': function(ticket, action) {
              let ticket_method = ticket[action];
              if (!_.isFunction(ticket_method)) return;

              return ticket_method.call(ticket).then((r) => {
                console.log('action %s result:', action, r);
                // console.log('ticket now:', ticket);
                self.$.workstation.notifyTicketAction(ticket, action);
                return true;
              });

            },
          };

        },
        lockArriveButton() {
          let delay = this.$.settings.getItem('lock_delay');
          if (delay) {
            let button = this.querySelector('.ticket-action paper-button[ticket-action=arrived]');
            button.setAttribute('disabled', true);
            this.debounce('lock-arrive-button', () => {
              button.removeAttribute('disabled');
            }, delay * 1000);
          }
        },
        ticketAction(e) {
          let data = e.detail;
          let ticket = data.ticket;
          let action = data.action;

          let button = this.querySelector('.ticket-action paper-button[ticket-action=' + action + ']');
          let spinner = button ? button.querySelector('paper-spinner') : false;
          if (button && spinner) {
            button.setAttribute('disabled', true);
            spinner.setAttribute('active', true);
          }

          let done = this.action_handlers[action] ? this.action_handlers[action](ticket) : this.action_handlers.default(ticket, action);

          if (button && spinner) {
            done.then(() => {
              spinner.removeAttribute('active');
              button.removeAttribute('disabled');
            }).catch(() => {
              spinner.removeAttribute('active');
              button.removeAttribute('disabled');
            })
          }
        }
      });
    })();
  </script>

</dom-module>